name: Two neo4j instances setup test
on:
  push:
    branches:
      - master
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: neo4j-instance-1 setup (ports 7474, 7687)
        run: |
          docker run --detach \
            --name neo4j-instance-1 \
            --hostname neo4j-instance-1 \
            --env NEO4J_AUTH=none \
            --publish 7474:7474 \
            --publish 7687:7687 \
            neo4j:3.5
      - name: neo4j-instance-2 setup (ports 8474, 8687)
        run: |
          docker run --detach \
            --name neo4j-instance-2 \
            --hostname neo4j-instance-2 \
            --env NEO4J_AUTH=none \
            --publish 8474:7474 \
            --publish 8687:7687 \
            neo4j:3.5
      - name: Wait for neo4j-instance-1 to be ready
        timeout-minutes: 1
        run: (docker logs -f neo4j-instance-1 & ) | grep -q Started
      - name: Wait for neo4j-instance-2 to be ready
        timeout-minutes: 1
        run: (docker logs -f neo4j-instance-2 & ) | grep -q Started
      - name: Verify neo4j-instance-1 connectivity
        run: curl -sI http://localhost:7474
      - name: Verify neo4j-instance-2 connectivity
        run: curl -sI http://localhost:8474
